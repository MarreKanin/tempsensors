# Information sensor read

Data is generated by [rtl_433](https://github.com/merbanan/rtl_433) and started by a python script initialized by /etc/rc.local. This makes the script startup on boot and will go as long as the device is powered on.

```
/usr/bin/python /home/pi/temp/getTemp.py
```

getTemp.py is a program that just runs the rtl_433 module, but can be run from a bashscript aswell. Contents of getTemp.py:

```python
#!/usr/bin/python
import os
import json
program = os.popen('/home/pi/rtl_433/build/src/rtl_433 -F json > /home/pi/temp/data/temp.txt')
```

This stores the datafindings to temp.txt constantly as it finds data. The data is now going to be transformed and sent to a external API to get stored in a database. I use a cronjob to initialize the data read and the data sender.

```
* * * * * /usr/bin/python /home/pi/temp/sendTemp.py &> /tmp/errors
```

```python
import json
import requests
def main():
        data = []
        with open('/home/pi/temp/data/temp.txt', 'r') as file:
                try:
                        for line in file:
                                line = line.replace('\n', '')
                                if len(line) < 40:
                                        print("file is empty")
                                        raise SystemExit
                                if len(line) > 40:
                                        data.append(line)
                except:
                        raise SystemExit
        try:
                for line in data:
                        print(line)
                        templine = json.loads(line)
                        battery = templine['battery']
                        print(battery)
                        humidity = templine['humidity']
                        temprature = templine['temperature_C']
                        time = templine['time']
                        model = templine['model']
                        id = templine['id']
                        channel = templine['channel']
                        try:
                                senddata(battery, humidity, temprature, time, model, id, channel)
                        except Exception as e:
                                print(e)
        except Exception as e:
                print(e)
                raise SystemExit
        with open('/home/pi/temp/data/temp.txt', 'w+') as file:
                # Delete data in temp.txt
                pass
def senddata(battery, humidity, temprature, time, model, id, channel):
        url = 'https://external-api.url/transferTempData.php'
        data = {"time": time, "model": model, "housecode": id, "channel": channel, "battery": battery, "temp": temprature, "humidity": humidity}
        thesending = requests.post(url, data=data, verify=False)
if __name__ == "__main__":
        main()
```

### Recieving data

I have a server running with mariahDb and php with a simple, unsecure php script that recieves data and stores it in the database. transferTempData.php:

```php
<?php
if ($_SERVER['REQUEST_METHOD'] == 'GET'){
    echo "Hello, this is a API for uploading tempratures for the server";
}

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    require('config.php');
    $time =  $_POST['time'];
    $model =  $_POST['model'];
    $housecode = $_POST['housecode'];
    $channel = $_POST['channel'];
    $battery = $_POST['battery'];
    $temp =  $_POST['temp'];
    $humidity = $_POST['humidity'];
    echo "<br />";
    echo "time: " . $time . "<br />";
    echo "model: " . $model . "<br />";
    echo "housecode: " . $housecode . "<br />";
    echo "channel: " . $channel . "<br />";
    echo "battery: " . $battery . "<br />";
    echo "temp: " . $temp . "<br />";
    echo "humidity: " . $humidity . "<br />";
    try {
        $sql = "INSERT into homeoutside (time, model, housecode, channel, battery, temp, humidity) VALUES( '$time', '$model', '$housecode', '$channel', '$battery', '$temp', '$humidity' )";
        $statement=$db->prepare($sql);
        $statement->execute();
        echo json_encode("ok");
        }

        catch(PDOException $e)
        {
        echo $sql . "<br>" . $e->getMessage();
        }
    }

?>
```

config.php:

```php
<?php
    $options = array(PDO::MYSQL_ATTR_INIT_COMMAND => 'SET NAMES utf8');
    try { $db = new PDO("mysql:host={"hostname"};dbname={"dbname"};charset=utf8", "username", "password", $options); }
    catch(PDOException $ex){ die("Failed to connect to the database: " . $ex->getMessage());}
    $db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    $db->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);
    error_reporting(E_ERROR | E_WARNING | E_PARSE);
?>
```
